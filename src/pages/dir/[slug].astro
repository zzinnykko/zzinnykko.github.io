---
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async () => {
    const dirsGlobResult = Object.entries(import.meta.glob("$/_dir/**.md"));

    const list = [];
    for (const [_, resolver] of dirsGlobResult) {
        const { frontmatter, file } = await resolver() as { frontmatter: { title: string, [key: string]: any }, file: string, [key: string]: any };
        const slug = file.split("/").pop()?.replace(/\.md$/, "").replace(/\[.*?\]/g, "").replace(/\s+/g, " ").trim();
        const title = frontmatter.title;
        const updated = new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Seoul' });
        const sort = frontmatter.sort ?? "asc";

        list.push({ slug, title, sort, updated });
    }
    
    const result = [];
    for (const { slug, title, sort, updated } of list) {
        const postGlobResult =  Object.entries(import.meta.glob(`$/_page/${slug}/*.md`)).sort((x, y) => x[0].localeCompare(y[0]));
        if (sort === "desc") postGlobResult.reverse();

        const postlist = [];
        for (const [_, resolver] of postGlobResult) {
            const { frontmatter, file } = await resolver() as { frontmatter: { title: string, [key: string]: any }, file: string, [key: string]: any };
            const posthref = "/page/" + file.split("/").pop()?.replace(/\.md$/, "").replace(/\[.*?\]/g, "").replace(/\s+/g, " ").trim();
            const posttitle = frontmatter.title;
            const postupdated = frontmatter.updated ?? "";

            postlist.push({ href: posthref, title: posttitle, updated: postupdated });
        }
        
        result.push({ params: { slug }, props: { posts: postlist, title, updated }});
    }

    return result;

}) satisfies GetStaticPaths;

const { posts, title, updated } = Astro.props;
---

<article class="dir">
    <h1 id="page-title">{ title } 카테고리 포스팅 리스트</h1>
    <div class="text-right">Last updated: { updated }</div>
    <ul>
        { posts.map((x) => (
            <li class="py-4"><a href={ x.href }>{ x.title }</a> Last updated: { x.updated }</li>
        )) }
    </ul>
</article>